---
title: "CHIC599 Project 2"
author: '36075596'
date: "`r Sys.Date()`"
output: 
  pdf_document:
    keep_tex: true
bibliography: references.bib
csl: "malaria-journal.csl"
link-citations: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,
                      results = 'hide', error = FALSE)

library(dplyr)
library(ggplot2)
library(cowplot)
library(sf)
library(raster)
library(tmap)
library(lme4)
library(PrevMap)
library(scico)

sth <- read.csv("data/ETH_sth.csv")
sth$Asc_examined <- as.numeric(sth$Asc_examined)
sth_sf <- st_as_sf(sth, coords = c("utm_x", "utm_y"))
st_crs(sth_sf) <- 32638

ETH_grid <- read.csv("data/ETH_grid.csv")

ETH_adm0 <- st_read("ETH_files/ETH_adm/ETH_adm0.shp")
ETH_adm0 <- st_transform(ETH_adm0, crs = 32638)

ETH_adm1 <- st_read("ETH_files/ETH_adm/ETH_adm1.shp")
ETH_adm1 <- st_transform(ETH_adm1, crs = 32638)

mcml <- control.mcmc.MCML(n.sim=10000, # number of simulations
                          burnin=2000, # the amount of samples to throw away
                          # the first simulations are not representative
                          # so these are thrown away
                          # 2000 is the minimum to throw away
                          thin=8) # Only retain every nth sample


```

## Introduction 

Soil-transmitted helminthiases (STH) represents the highest burden of disease for all neglected tropical diseases (NTD’s) across the world [@worldhealthorganizationEliminatingSoiltransmittedHelminthiases2012]. 
The disease is caused mainly by three types of helminths: hookworms (*Necator americanus* and *Ancylostoma duodenale*), *Ascaris lumbricoides* and *Trichuris trichuria*.
Although they do not have high mortality rates, infections can have significant impacts on health and quality of life.
They are associated with stunted growth, reduced cognitive development and micro-nutrient deficiency.
These effects are particularly concerning in school-age children and pregnant women. 

In Ethiopia, STH is a major public health concern, affecting over 79 million individuals [@sartoriusPrevalenceIntensitySoiltransmitted2021; @aemiroPrevalenceSoilTransmittedHelminthes2022].
Following guidance from the World Health Organization (WHO), the Ethiopian government launched a mass drug administration (MDA) project in 2015.
WHO recommends different MDA frequencies depending on the prevalence of STH [@worldhealthorganizationEliminatingSoiltransmittedHelminthiases2012].
If prevalence is over 50%, MDAs should take place twice a year.
If prevalence is between 20% and 50%, MDA should happen once a year.
Any areas where prevalence is under 20% should change strategies and focus on a case-by-case treatment schedule. 

In this project, I used open-access data to predict the prevalence of any STH across Ethiopia.
I also produced probabilities of exceeding 50% prevalence and of falling between 20% and 50% prevalence.
Using these maps, I created discrete rasters identifying areas that required treatment twice a year, areas that required treatment once a year, areas that should move to a case-by-case strategy and areas for which the uncertainty was too high to determine in which category they fell and therefore would require further data collection. 

# Methods 

## Data sources 

I downloaded STH data for Ethiopia from the Expanded Special Project to Eliminate NTDs (ESPEN), a project set up by the WHO African Regional Office to support national NTD control projects [@ESPENExpandedSpecial].
The data set contained geo-referrenced school surveys carried out across the country, including the number of children examined and the number of children that tested positive for each of the three STH groups (hookworms, *Ascaris lumbricoides* and *Trichuris trichuria*). 
Each entry had a geo-reliability and quality classification, referring to the reliability of the recorded latitude and longitude and the quality of the data. 
In my analyses, I only included those entries that had a reliable location recorded and were of sufficient quality. 

I used previous research to decide which covariates to download [@alelignSoilTransmittedHelminthInfections2015; @anegagrieEnvironmentalCharacteristicsHousehold2021; @eyayuPrevalenceIntensityInfection2022]. These included elevation, sourced from [DIVA GIS](https://www.diva-gis.org/) [@DIVAGISFreeSimple], friction surface and time to nearest healthcare centre, downloaded from the [Malaria Atlas Project](https://malariaatlas.org/) [@MalariaAtlasProject] (Figure 1).
Friction surface estimates the minutes required to travel one meter over land, producing a walking-only raster and a motorized vehicle raster. 
Similarly, the time to nearest healthcare centre estimates the minutes required to reach said centre, both walking-only and with motorized vehicle. 
I also downloaded a shapefile of all the rivers in Ethiopia which I used to create a raster of distance to the nearest river.  

```{r covariates_figure, fig.cap= "\\textit{Covariate rasters for Ethiopia. A: Altitude, in meters. B: Distance to nearest river, in kilometers. C: Friction surface walking only, in minutes required to travel one meter. D: Friction surface motorized vehicle, same units as C. E: Walking only travel time to nearest healthcare centre, in minutes. F: Motorized vehicle travel time to nearest healthcare centre, in minutes. White dots represent STH data collection points.}", fig.height=26, fig.width=20}

r1 <- ggplot()+
  geom_raster(data = ETH_grid, aes(x=X, y=Y, fill = altitude))+
  geom_sf(data = ETH_adm0, col = "black", fill = NA)+
  geom_sf(data = sth_sf, col = "white", size = 2)+
  scale_fill_scico(palette = "bamako", name = "Altitude (m)")+
  theme_void()+
  theme(legend.text = element_text(size = 15),
        legend.title = element_text(size = 19))

r2 <- ggplot()+
  geom_raster(data = ETH_grid, aes(x=X, y=Y, fill = riv_dist))+
  geom_sf(data = ETH_adm0, col = "black", fill = NA)+
  geom_sf(data = sth_sf, col = "white", size = 2)+
  scale_fill_scico(palette = "davos", name = "Distance (km)")+
  theme_void()+
  theme(legend.text = element_text(size = 15),
        legend.title = element_text(size = 19))

r3 <- ggplot()+
  geom_raster(data = ETH_grid, aes(x=X, y=Y, fill = fric_w))+
  geom_sf(data = ETH_adm0, col = "black", fill = NA)+
  geom_sf(data = sth_sf, col = "white", size = 2)+
  scale_fill_scico(palette = "acton", name = "Time (min)")+
  theme_void()+
  theme(legend.text = element_text(size = 15),
        legend.title = element_text(size = 19))

r4 <- ggplot()+
  geom_raster(data = ETH_grid, aes(x=X, y=Y, fill = fric_m))+
  geom_sf(data = ETH_adm0, col = "black", fill = NA)+
  geom_sf(data = sth_sf, col = "white", size = 2)+
  scale_fill_scico(palette = "acton", name = "Time (min)")+
  theme_void()+
  theme(legend.text = element_text(size = 15),
        legend.title = element_text(size = 19))

r5 <- ggplot()+
  geom_raster(data = ETH_grid, aes(x=X, y=Y, fill = travel_w))+
  geom_sf(data = ETH_adm0, col = "black", fill = NA)+
  geom_sf(data = sth_sf, col = "white", size = 2)+
  scale_fill_scico(palette = "oslo", name = "Time (min)")+
  theme_void()+
  theme(legend.text = element_text(size = 15),
        legend.title = element_text(size = 19))

r6 <- ggplot()+
  geom_raster(data = ETH_grid, aes(x=X, y=Y, fill = travel_m))+
  geom_sf(data = ETH_adm0, col = "black", fill = NA)+
  geom_sf(data = sth_sf, col = "white", size = 2)+
  scale_fill_scico(palette = "oslo", name = "Time (min)")+
  theme_void()+
  theme(legend.text = element_text(size = 15),
        legend.title = element_text(size = 19))

plot_grid(r1, r2, r3, r4, r5, r6,
          labels = "AUTO",
          label_size = 25,
          align = "hv",
          nrow = 3,
          ncol = 2)

```


## Data analysis 

I started the data analysis by assessing how each covariate was related to the dependant variable. 
I created a logit transformation using each of the three STH species’ data, as defined in the equation below. 
I used this against each covariate to see how--or if--covariates should be introduced into the final models. 

$$ \text{logit} = \log\left(\frac{y+0.5}{n-y+0.5}\right) $$


Once I had determined the relationship between the covariates and each of the STH species logit transformation, I proceeded to build binomial generalised linear mixed-effects models.
I created one model for each species, as defined by the equation below.

$$ \log\left(\frac{p}{1-p}\right) = x_i^\intercal\beta + Z_i $$

Where:

- $x_i^\intercal\beta$ holds the intercept and any covariates included in the model. I selected the covariates by assessing associations with the logit transformation
- $Z_i$ represents the random effects for each location $i$, assumed to be normally distributed and independant, identical distributions, such that 

$$ Z_i \sim N(0, \sigma^2)  $$

I assessed if there was overdispersion present by extracting the variance of the random effects ($\sigma^2$). Using a variogram, I checked if there was residual spatial correlation that remained unaccounted for by the generalised linear mixed-effects models. 

I carried on analysing the data by building a binomial geostatistical model. This model is defined by the equation below. 

$$ \log\left(\frac{p}{1-p}\right) = x_i^\intercal\beta + S(x_i) + Z_i $$

Where: 

- $x_i^\intercal\beta$ represents the covariates for each location $i$ and the intercept
- $S(x)$ denotes the spatial Gaussian process, with assumed stationarity and isotropy
- $Z_i$ is the nugget effect, a normally distributed random variable representing non-spatial variation, small-scale spatial variation or measurement error


As this is a binomial geostatistical model, it requires initial guesses to be given for the unknown parameters.
The unknown parameters are: $\beta$, the coefficients of the covariates (including the intercept);
$\sigma^2$, the variance of the spatial Gaussian process;
$\phi$, the scale of the spatial correlation;
and $\tau^2$, the variance of the nugget.
I used the coefficients of the covariates from a generalized linear model, which had the same covariates as those included in the binomial geostatistical model, as the initial guesses for $\beta$.
I produced the guesses for $\sigma^2$, $\phi$ and $\tau^2$ by using the empirical variogram and fitting a weighted least-squares estimate line through it, producing a set a values that would create this line.
I then extracted the values for each of the parameters from the geostatistical model and used them as guesses for the same model.
I repeated this until the values of the parameters stabilised. 

I performed the inference explained above using Markov Chain Monte Carlo (MCMC) methods.
I ran 10,000 simulations, discarding the first 2,000 results and only keeping every 8^th result thereafter.
This resulted in 1,000 samples per location. 

## Prediction 

To create a predicted prevalence raster for Ethiopia, I made a grid of points across the entire country, at a resolution of 10 km.
I extracted the values for each of the covariates at each of these points and saved them as a data frame.
I used this data frame to predict the prevalence of each of the STH species at every grid point, using the same MCMC methods described previously. 

To create a raster of the prevalence of at least one STH species, I extracted the MCMC samples for each of the species.
I then used this to, firstly, estimate the “anti-prevalence” of each species and, secondly, combine these to estimate the prevalence of at least one species.
This is described in the equation below.

$$ P(S_1 \vee S_2 \vee S_3) = 1 - P(\bar{S_1} \wedge \bar{S_2} \wedge \bar{S_3}) $$

I used these samples of at least one species to create two probability rasters: one showing the probability of exceeding 50% prevalence and a second showing the probability of having between 20% and 50% prevalence.
I combined these rasters to create maps to show what areas needed different strategies, at three different confidence levels: 90% confidence, 75% confidence and 60% confidence. 
The strategies referred to the recommendations set out by the WHO, where MDAs should happen twice a year for areas with over 50% prevalence of STH, once a year for areas with prevalence between 20% and 50% and strategies should move to a case-by-case basis in areas where prevalence was below 20%. 
I also created a fourth category to indicate areas where confidence was too low and would therefore need further investigations. 

# Results 

## ESPEN data 

There were a total of 146 unique data collection locations across Ethiopia (Figure 2). The data collection occurred across a number of years, at varying rates, as described in Table 1. Due to lack of multiple rasters representing the change in time, this temporal change was not accounted for in any further analyses. 

```{r STH_locations, fig.cap= "\\textit{STH data collection locations.}", fig.height=3, fig.width=7}

ggplot()+
  geom_sf(data = ETH_adm1, col = "grey60", fill = NA, size = 0.15)+
  geom_sf(data = ETH_adm0, col = "black", fill = NA)+
  geom_sf(data=sth_sf, col = "red")+
  theme_void()

```

\newpage
```{r STH_years_table, results='markup'}

table.1 <- sth %>%
  count(Year)

knitr::kable(table.1, col.names = c("Year", "Number of surveys"),
             caption = "Number of STH surveys performed by year.")
  

```

## Hookworms 

I performed a logit transformation on the hookworm data to determine the association with each of the covariates (Figure 3).

```{r e.logit_plots}

sth$HK_e.logit <- log((sth$HK_positive+0.5)/(sth$HK_examined-sth$HK_positive+0.5))
sth$Asc_e.logit <- log((sth$Asc_positive+0.5)/(sth$Asc_examined-sth$Asc_positive+0.5))
sth$TT_e.logit <- log((sth$TT_positive+0.5)/(sth$TT_examined-sth$TT_positive+0.5))

species <- c("HK", "Asc", "TT")
vars <- names(sth)[c(18:23)]
vars_labels <- c("Altitude (m)", "Distance (km)", "Time (min)",
                 "Time (min)",
                 "Time (min)",
                 "Time (min)")

plot.list <- list()

for (i in 1:length(species)) {
  
  for (j in 1:length(vars)) {
    
    plot.list[[species[i]]][[vars[j]]] <-
      ggplot(sth, aes_string(x = vars[j],
                             y = paste0(species[i], "_e.logit")))+
      geom_point()+
      labs(x = vars_labels[j], y = "logit")+
      theme(axis.text = element_text(size = 5),
            axis.title = element_text(size = 8))
    
  }
  
}


```

```{r HK_e.logit, fig.cap="\\textit{Covariates against empirical logit transformation of hookworm data. A: Altitude, in meters. B: Distance to nearest river, in kilometers. C: Friction surface walking only, in minutes required to travel one meter. D: Friction surface motorized vehicle, same units as C. E: Walking only travel time to nearest healthcare centre, in minutes. F: Motorized vehicle travel time to nearest healthcare centre, in minutes.}", fig.height=4, fig.width=8}

plot_grid(plot.list$HK$altitude, plot.list$HK$riv_dist,
          plot.list$HK$fric_w,plot.list$HK$fric_m,
          plot.list$HK$travel_w, plot.list$HK$travel_m,
          labels = "AUTO",
          align = "hv",
          nrow = 3, ncol = 2)

```

 
Focusing on altitude, most of the data points are located in the middle of the range, with a few points on either side.
There does appear to be a linear relationship present, with the empirical logit increasing as altitude increases.
With distance to river, there is a high density of points located in the lower end of the range. 
The friction variables and the travel variables show very similar relationships.
Most of the data points are located on the lower end of the scales. 
The walking travel time to nearest healthcare centre has the lowest density, with the points more spread out across the range. 

Informed by these plots, I decided to include altitude, distance to river and walking travel time to nearest health care centre in further models. 
I only included one of the friction and travel variables due to risks of introducing multi-collinearity. 

```{r HK_glmer}

sth <- sth[complete.cases(sth),]
sth$ID.location <- create.ID.coords(sth, coords = ~utm_x+utm_y)

glmer.fit.HK <- glmer(cbind(HK_positive, HK_examined-HK_positive) ~ 
                        altitude + riv_dist + 
                        travel_w +
                        (1|ID.location),
                      data = sth,
                      family = binomial)

HK.glmer.sigma2 <- as.data.frame(summary(glmer.fit.HK)$varcor)[1,4]

```


I used these variables, without performing any transformations on them, to build a binomial generalised linear mixed-effects model, as defined in the methods section.
The variance of the random effects was `r round(HK.glmer.sigma2, digits = 3)`, showing evidence of overdispersion.
The variogram for this model also showed residual spatial correlation (Figure 4). 


```{r HK.variogram_1, include = FALSE}
variog.HK <- spat.corr.diagnostic(formula = HK_positive ~ 
                       altitude + riv_dist + travel_w, 
                     units.m = ~HK_examined,
                     coords = ~I(utm_x/1000)+I(utm_y/1000), # change to km 
                     data = sth, 
                     likelihood = "Binomial",
                     uvec = seq(0, 600, length = 15), 
                     n.sim = 10000,
                     which.test = "variogram")


```

```{r HK.variogram_2, fig.cap="\\textit{Variogram of Hookworm data. Plot shows evidence of residual spatial correlation that remains unaccounted for by the generalised linear mixed-effects model.}", fig.height=4, fig.width=8}

HK.variog.df <- data.frame(
  u = as.numeric(variog.HK$distance.bins),
  v = as.numeric(variog.HK$obs.variogram),
  v.upper = variog.HK$upper.lim,
  v.lower = variog.HK$lower.lim)

ggplot(HK.variog.df, aes(x = u))+
  geom_ribbon(aes(ymin = v.lower, ymax = v.upper), fill = "skyblue1", alpha = 0.75)+
  geom_line(aes(y = v))+
  labs(x = "Spatial distance (km)", y = "Variogram")+
  theme_light()

```

```{r HK.geostat.model, include=FALSE}

par0.HK <- c(-3.2500755516, -0.0001313163, 0.0331892189, 32.3256263836,
             3.1795564677, 77.0774275358, 1.1766335110)

geostat.fit.HK <- binomial.logistic.MCML(formula = HK_positive ~
                                           altitude + riv_dist + fric_w,
                                         units.m = ~ HK_examined,
                                         coords = ~I(utm_x/1000)+I(utm_y/1000),
                                         data = sth,
                                         par0 = par0.HK,
                                         control.mcmc = mcml,
                                         kappa = 0.5,
                                         start.cov.pars = c(par0.HK[6],
                                                            par0.HK[7]/par0.HK[5]),
                                         method = "nlminb")

```


I followed by building a binomial geostatistical model, as described in the methods section. 
I performed four rounds of using guesses for the model parameters before arriving to a final model. 
The final parameters are described in Table 2. 

```{r HK.geostat.params, results='markup'}

HK.geostat.params.df <- as.data.frame(summary(geostat.fit.HK,
                                           log.cov.pars=FALSE)$cov.pars)

rownames(HK.geostat.params.df) <- c("$\\sigma^2$",
                                 "$\\phi$",
                                 "$\\tau^2$")

knitr::kable(HK.geostat.params.df, "pipe", digits = 3,
             caption = "Estimated parameters from binomial geostatistical model - Hookworms")


```


Using this model, I created three rasters: one showing the predicted prevalence of hookworms across Ethiopia, one showing the probability of having between 20% and 50% prevalence and the final one showing the probability of exceeding 50% prevalence (Figure 5). 

```{r HK.prediction.rasters, fig.cap="*Rasters for Hookworm estimates. A: Predicted prevalence. B: Probability of having prevalence between 20% and 50%. C: Probability of exceeding 50% prevalence.*", fig.width=8, fig.height=4}

ETH_grid$HK.prev.mean <- ETH_grid$HK.prev.mean*100

HK.1 <- ggplot()+
  geom_raster(data=ETH_grid, aes(x=X, y=Y, fill=HK.prev.mean))+
  geom_sf(data = ETH_adm1, col = "grey", fill = NA, size = 0.2)+
  geom_sf(data=ETH_adm0, col = "black", fill = NA)+
  scale_fill_scico(palette = "batlow", limits = c(0, 100),
                   name = "Prevalence")+
  theme_void()

HK.2 <- ggplot()+
  geom_raster(data=ETH_grid, aes(x=X, y=Y, fill=HK.between.20_50))+
  geom_sf(data = ETH_adm1, col = "grey", fill = NA, size = 0.2)+
  geom_sf(data=ETH_adm0, col = "black", fill = NA)+
  scale_fill_scico(palette = "vik", limits = c(0, 1),
                   name = "Probability")+
  theme_void()

HK.3 <- ggplot()+
  geom_raster(data=ETH_grid, aes(x=X, y=Y, fill=HK.exceed50))+
  geom_sf(data = ETH_adm1, col = "grey", fill = NA, size = 0.2)+
  geom_sf(data=ETH_adm0, col = "black", fill = NA)+
  scale_fill_scico(palette = "vik", limits = c(0, 1),
                   name = "Probability")+
  theme_void()

plot_grid(HK.1, HK.2, HK.3, 
          labels = "AUTO", align = "hv",
          nrow = 1)

```


The predicted prevalence shows a pocket of high prevalence of hookworm in the eastern region of Ethiopia. 
This area does overlap with a high probability of exceeding 50% prevalence. 
However, there is low probability of having between 20% and 50% prevalence across the entire country. 

\newpage

## *Ascaris lumbricoides* 

The associations between each covariate and the logit transformation for the Ascaris lumbricoides data is plotted in Figure 6. 

```{r Asc_e.logit, fig.cap="\\textit{Covariates against empirical logit transformation of Ascaris lumbricoides data. A: Altitude, in meters. B: Distance to nearest river, in kilometers. C: Friction surface walking only, in minutes required to travel one meter. D: Friction surface motorized vehicle, same units as C. E: Walking only travel time to nearest healthcare centre, in minutes. F: Motorized vehicle travel time to nearest healthcare centre, in minutes.}", fig.height=4, fig.width=8}

plot_grid(plot.list$Asc$altitude, plot.list$Asc$riv_dist,
          plot.list$Asc$fric_w,plot.list$Asc$fric_m,
          plot.list$Asc$travel_w, plot.list$Asc$travel_m,
          labels = "AUTO",
          align = "hv",
          nrow = 3, ncol = 2)

```

All the associations are very similar to those seen for the hookworm logit transformation. 
Both altitude and distance to nearest river show less concentration of data points across the ranges, but this does not seem to affect the associations with the logit data. 
As with hookworms, the travel and friction data show a high density of data points on the lower end of the range. 
I decided to include the same covariates as for hookworm: altitude, distance to nearest river and walking travel time to closest healthcare centre. 

```{r Asc_glmer}

glmer.fit.Asc <- glmer(cbind(Asc_positive, Asc_examined-Asc_positive) ~
                         altitude + riv_dist + travel_w +
                         (1|ID.location),
                       data = sth,
                       family = binomial)

Asc.glmer.sigma2 <- as.data.frame(summary(glmer.fit.Asc)$varcor)[1,4]

```

The binomial generalised linear mixed-effects model showed evidence of overdispersion, as the variance of the random effects was `r round(Asc.glmer.sigma2, digits = 3)`. The variogram for this model also showed the presence of residual spatial correlation (Figure 7). 

```{r Asc.variogram_1, include = FALSE}
variog.Asc <- spat.corr.diagnostic(formula = Asc_positive ~ 
                       altitude + riv_dist + travel_w, 
                     units.m = ~Asc_examined,
                     coords = ~I(utm_x/1000)+I(utm_y/1000), # change to km 
                     data = sth[complete.cases(sth),], 
                     likelihood = "Binomial",
                     uvec = seq(0, 500, length = 15), 
                     n.sim = 10000,
                     which.test = "variogram")


```

```{r Asc.variogram_2, fig.cap="\\textit{Variogram of Ascaris lumbricoides data. Plot shows evidence of residual spatial correlation that remains unaccounted for by the generalised linear mixed-effects model.}", fig.height=4, fig.width=8}

Asc.variog.df <- data.frame(
  u = as.numeric(variog.Asc$distance.bins),
  v = as.numeric(variog.Asc$obs.variogram),
  v.upper = variog.Asc$upper.lim,
  v.lower = variog.Asc$lower.lim)

ggplot(Asc.variog.df, aes(x = u))+
  geom_ribbon(aes(ymin = v.lower, ymax = v.upper), fill = "skyblue1", alpha = 0.75)+
  geom_line(aes(y = v))+
  labs(x = "Spatial distance (km)", y = "Variogram")+
  theme_light()

```

```{r Asc.geostat.model, include=FALSE}

par0.Asc <- c(-3.3840984086, 0.0005154041, -0.0002321412, -0.0028610129,
             1.5536212160, 173.6501762833, 0.9918892349)


geostat.fit.Asc <- binomial.logistic.MCML(formula = Asc_positive ~
                                            altitude + riv_dist + travel_w,
                                          units.m = ~Asc_examined,
                                          coords = ~I(utm_x/1000)+I(utm_y/1000),
                                          data = sth,
                                          par0 = par0.Asc,
                                          control.mcmc = mcml,
                                          kappa = 0.5,
                                          start.cov.pars = c(par0.Asc[6],
                                                            par0.Asc[7]/par0.Asc[5]),
                                          method = "nlminb")

```

I performed four rounds of parameter guessing before reaching a final binomial geostatistical model.
These are described in Table 3.

```{r Asc.geostat.params, results='markup'}

Asc.geostat.params.df <- as.data.frame(summary(geostat.fit.Asc,
                                           log.cov.pars=FALSE)$cov.pars)

rownames(Asc.geostat.params.df) <- c("$\\sigma^2$",
                                 "$\\phi$",
                                 "$\\tau^2$")

knitr::kable(Asc.geostat.params.df, "pipe", digits = 3,
             caption = "Estimated parameters from binomial geostatistical model - Ascaris lumbricoides")


```

I used this model to create the same three rasters as I did for hookworms: predicted prevalence, probability of having between 20% and 50% prevalence and probability of exceeding 50% prevalence (Figure 8). 

```{r Asc.prediction.rasters, fig.cap="*Rasters for Ascaris lumbricoides estimates. A: Predicted prevalence. B: Probability of having prevalence between 20% and 50%. C: Probability of exceeding 50% prevalence.*", fig.height=4, fig.width=8}

ETH_grid$Asc.prev.mean <- ETH_grid$Asc.prev.mean*100

Asc.1 <- ggplot()+
  geom_raster(data=ETH_grid, aes(x=X, y=Y, fill=Asc.prev.mean))+
  geom_sf(data = ETH_adm1, col = "grey", fill = NA, size = 0.2)+
  geom_sf(data=ETH_adm0, col = "black", fill = NA)+
  scale_fill_scico(palette = "batlow", limits = c(0, 100),
                   name = "Prevalence")+
  theme_void()

Asc.2 <- ggplot()+
  geom_raster(data=ETH_grid, aes(x=X, y=Y, fill=Asc.between.20_50))+
  geom_sf(data = ETH_adm1, col = "grey", fill = NA, size = 0.2)+
  geom_sf(data=ETH_adm0, col = "black", fill = NA)+
  scale_fill_scico(palette = "vik", limits = c(0, 1),
                   name = "Probability")+
  theme_void()

Asc.3 <- ggplot()+
  geom_raster(data=ETH_grid, aes(x=X, y=Y, fill=Asc.exceed50))+
  geom_sf(data = ETH_adm1, col = "grey", fill = NA, size = 0.2)+
  geom_sf(data=ETH_adm0, col = "black", fill = NA)+
  scale_fill_scico(palette = "vik", limits = c(0, 1),
                   name = "Probability")+
  theme_void()

plot_grid(Asc.1, Asc.2, Asc.3, 
          labels = "AUTO", align = "hv",
          nrow = 1)

```


These maps show that the prevalence for Ascaris lumbricoides across Ethiopia is very low. 

\newpage

## *Trichuris trichuria*

I plotted the logit transformed Trichuris trichuria data against each of the covariates (Figure 9). 

```{r TT_e.logit, fig.cap="\\textit{Covariates against empirical logit transformation of Trichuris trichuria data. A: Altitude, in meters. B: Distance to nearest river, in kilometers. C: Friction surface walking only, in minutes required to travel one meter. D: Friction surface motorized vehicle, same units as C. E: Walking only travel time to nearest healthcare centre, in minutes. F: Motorized vehicle travel time to nearest healthcare centre, in minutes.}", fig.height=4, fig.width=8}

plot_grid(plot.list$TT$altitude, plot.list$TT$riv_dist,
          plot.list$TT$fric_w,plot.list$TT$fric_m,
          plot.list$TT$travel_w, plot.list$TT$travel_m,
          labels = "AUTO",
          align = "hv",
          nrow = 3, ncol = 2)

```

The only notable difference of the Trichuris trichuria logit data is that when plotting it against the distance to river it seems to be more spread out than the data points for hookworms and *Ascaris lumbricoides*.
All other associations are very similar. 
Therefore, I used the same covariates as I did in models for hookworms and for *Ascaris lumbricoides*. 

```{r TT_glmer}

glmer.fit.TT <- glmer(cbind(TT_positive, TT_examined-TT_positive) ~
                         altitude + riv_dist + travel_w +
                         (1|ID.location),
                       data = sth,
                       family = binomial)

TT.glmer.sigma2 <- as.data.frame(summary(glmer.fit.TT)$varcor)[1,4]

```

The binomial generalised linear mixed-effects model also showed evidence of overdispersion for *Trichuris trichuria*, as the variance of the random effects was `r round(TT.glmer.sigma2, digits = 3)`. The variogram showed evidence of residual spatial correlation (figure 10).

```{r TT.variogram_1, include = FALSE}
variog.TT <- spat.corr.diagnostic(formula = TT_positive ~ 
                       altitude + riv_dist + travel_w, 
                     units.m = ~TT_examined,
                     coords = ~I(utm_x/1000)+I(utm_y/1000), # change to km 
                     data = sth[complete.cases(sth),], 
                     likelihood = "Binomial",
                     uvec = seq(0, 500, length = 15), 
                     n.sim = 10000,
                     which.test = "variogram")


```

```{r TT.variogram_2, fig.cap="\\textit{Variogram of Ascaris lumbricoides data. Plot shows evidence of residual spatial correlation that remains unaccounted for by the generalised linear mixed-effects model.}", fig.height=4, fig.width=8}

TT.variog.df <- data.frame(
  u = as.numeric(variog.TT$distance.bins),
  v = as.numeric(variog.TT$obs.variogram),
  v.upper = variog.TT$upper.lim,
  v.lower = variog.TT$lower.lim)

ggplot(TT.variog.df, aes(x = u))+
  geom_ribbon(aes(ymin = v.lower, ymax = v.upper), fill = "skyblue1", alpha = 0.75)+
  geom_line(aes(y = v))+
  labs(x = "Spatial distance (km)", y = "Variogram")+
  theme_light()

```

```{r TT.geostat.model, include=FALSE}

par0.TT <- c(-4.1002753787, -0.0001941095, 0.0568812496, -0.0016306050,
             1.7642179305, 77.2714428406, 0.6446155758)


geostat.fit.TT <- binomial.logistic.MCML(formula = TT_positive ~
                                           altitude + riv_dist + travel_w,
                                         units.m = ~TT_examined,
                                         coords = ~I(utm_x/1000)+
                                           I(utm_y/1000), # change to km 
                                         data = sth,
                                         par0 = par0.TT,
                                         control.mcmc = mcml,
                                         kappa = 0.5,
                                         start.cov.pars = c(par0.TT[6],
                                                            par0.TT[7]/par0.TT[5]),
                                         method = "nlminb")

```

I ran the parameter guesses six times until I reached a final model. The parameters are described in Table 5. I predicted the prevalence and the probability rasters for Trichuris trichuria using this model (Figure 11).

```{r TT.geostat.params, results='markup'}

TT.geostat.params.df <- as.data.frame(summary(geostat.fit.TT,
                                           log.cov.pars=FALSE)$cov.pars)

rownames(TT.geostat.params.df) <- c("$\\sigma^2$",
                                 "$\\phi$",
                                 "$\\tau^2$")

knitr::kable(TT.geostat.params.df, "pipe", digits = 3,
             caption = "Estimated parameters from binomial geostatistical model - Trichuris trichuria")


```

```{r TT.prediction.rasters, fig.cap="*Rasters for Trichuris trichuria estimates. A: Predicted prevalence. B: Probability of having prevalence between 20% and 50%. C: Probability of exceeding 50% prevalence.*", fig.height=4, fig.width=8}

ETH_grid$TT.prev.mean <- ETH_grid$TT.prev.mean*100

TT.1 <- ggplot()+
  geom_raster(data=ETH_grid, aes(x=X, y=Y, fill=TT.prev.mean))+
  geom_sf(data = ETH_adm1, col = "grey", fill = NA, size = 0.2)+
  geom_sf(data=ETH_adm0, col = "black", fill = NA)+
  scale_fill_scico(palette = "batlow", limits = c(0, 100),
                   name = "Prevalence")+
  theme_void()

TT.2 <- ggplot()+
  geom_raster(data=ETH_grid, aes(x=X, y=Y, fill=TT.between.20_50))+
  geom_sf(data = ETH_adm1, col = "grey", fill = NA, size = 0.2)+
  geom_sf(data=ETH_adm0, col = "black", fill = NA)+
  scale_fill_scico(palette = "vik", limits = c(0, 1),
                   name = "Probability")+
  theme_void()

TT.3 <- ggplot()+
  geom_raster(data=ETH_grid, aes(x=X, y=Y, fill=TT.exceed50))+
  geom_sf(data = ETH_adm1, col = "grey", fill = NA, size = 0.2)+
  geom_sf(data=ETH_adm0, col = "black", fill = NA)+
  scale_fill_scico(palette = "vik", limits = c(0, 1),
                   name = "Probability")+
  theme_void()

plot_grid(TT.1, TT.2, TT.3, 
          labels = "AUTO", align = "hv",
          nrow = 1)

```

These maps show that, overall, there is very low prevalence of *Trichuris trichuria* across Ethiopia. The only exception is a small area in the eastern region of Ethiopia, where prevalence appears to be extremely high. 

\newpage

## Any STH species 

As described in the methods section, I combined the estimated prevalences of the three STH species to create an estimated prevalence of any STH species.
I used this estimate to create 3 rasters: one showing the estimated prevalence, one showing the probability of having between 20% and 50% prevalence and a third showing the probability of exceeding 50% prevalence (Figure 12). 

```{r any.sth.prediction.rasters, fig.cap="*Rasters for any STH species' estimates. A: Predicted prevalence. B: Probability of having prevalence between 20% and 50%. C: Probability of exceeding 50% prevalence.*", fig.height=4, fig.width=8}

ETH_grid$any.sth.prev.mean <- ETH_grid$any.sth.prev.mean*100

any.sth.1 <- ggplot()+
  geom_raster(data=ETH_grid, aes(x=X, y=Y, fill=any.sth.prev.mean))+
  geom_sf(data = ETH_adm1, col = "grey", fill = NA, size = 0.2)+
  geom_sf(data=ETH_adm0, col = "black", fill = NA)+
  scale_fill_scico(palette = "batlow", limits = c(0, 100),
                   name = "Prevalence")+
  theme_void()

any.sth.2 <- ggplot()+
  geom_raster(data=ETH_grid, aes(x=X, y=Y, fill=any.sth.between.20_50))+
  geom_sf(data = ETH_adm1, col = "grey", fill = NA, size = 0.2)+
  geom_sf(data=ETH_adm0, col = "black", fill = NA)+
  scale_fill_scico(palette = "vik", limits = c(0, 1),
                   name = "Probability")+
  theme_void()

any.sth.3 <- ggplot()+
  geom_raster(data=ETH_grid, aes(x=X, y=Y, fill=any.sth.exceed50))+
  geom_sf(data = ETH_adm1, col = "grey", fill = NA, size = 0.2)+
  geom_sf(data=ETH_adm0, col = "black", fill = NA)+
  scale_fill_scico(palette = "vik", limits = c(0, 1),
                   name = "Probability")+
  theme_void()

plot_grid(any.sth.1, any.sth.2, any.sth.3, 
          labels = "AUTO", align = "hv",
          nrow = 1)

```

These maps show that, as described above, there is an area in the eastern region of Ethiopia that does have high prevalence for any STH species.

I combined these estimates to create a discrete raster, identifying what strategy should be used in which area. I created these with three levels of confidence (Figure 13).

```{r discrete.rasters, fig.cap="*STH control strategies to use for each area, by confidence level. A: 90% confidence, B: 75% confidence C: 60% confidence.*", fig.height=4, fig.width=8}

ETH_grid$discrete.90 <- factor(ETH_grid$discrete.90,
                               levels = c("Once a year", "Twice a year",
                                          "Case-by-case", "More data needed"), 
                               labels = c("Once a year", "Twice a year",
                                          "Case-by-case", "More data needed"))

ETH_grid$discrete.75 <- factor(ETH_grid$discrete.75,
                               levels = c("Once a year", "Twice a year",
                                          "Case-by-case", "More data needed"), 
                               labels = c("Once a year", "Twice a year",
                                          "Case-by-case", "More data needed"))

ETH_grid$discrete.60 <- factor(ETH_grid$discrete.60, 
                               levels = c("Once a year", "Twice a year",
                                          "Case-by-case", "More data needed"), 
                               labels = c("Once a year", "Twice a year",
                                          "Case-by-case", "More data needed"))


d1 <- ggplot()+
  geom_raster(data=ETH_grid, aes(x=X, y=Y, fill=discrete.90))+
  geom_sf(data = ETH_adm1, col = "grey60", fill = NA, size = 0.2)+
  geom_sf(data=ETH_adm0, col = "black", fill = NA)+
  scale_fill_manual(values = c("red", "orange", "green", "grey90"),
                    drop = FALSE, name = NULL)+
  theme_void()

d2 <- ggplot()+
  geom_raster(data=ETH_grid, aes(x=X, y=Y, fill=discrete.75))+
  geom_sf(data = ETH_adm1, col = "grey60", fill = NA, size = 0.2)+
  geom_sf(data=ETH_adm0, col = "black", fill = NA)+
  scale_fill_manual(values = c("red", "orange", "green", "grey90"),
                    drop = FALSE, name = NULL)+
  theme_void()

d3 <- ggplot()+
  geom_raster(data=ETH_grid, aes(x=X, y=Y, fill=discrete.60))+
  geom_sf(data = ETH_adm1, col = "grey60", fill = NA, size = 0.2)+
  geom_sf(data=ETH_adm0, col = "black", fill = NA)+
  scale_fill_manual(values = c("red", "orange", "green", "grey90"),
                    drop = FALSE, name = NULL)+
  theme_void()

drow <- plot_grid(d1+theme(legend.position = "none"),
          d2+theme(legend.position = "none"),
          d3+theme(legend.position = "none"),
          labels = "AUTO", nrow = 1, align = "hv")

legend_d <- get_legend(d3+theme(legend.position = "bottom"))

plot_grid(drow, legend_d,
          ncol = 1, rel_heights = c(1,0.1))

```


These maps show that, depending on the level of confidence, different areas would require different interventions. 

\newpage

# Conclusion 

In this report, I used geostatistical methods to produce an estimate of STH prevalence across Ethiopia.
I used this estimate to create maps identifying which areas required which control strategy, depending on the level of confidence needed. 

These maps showed that, overall, more data would be better to create a more informative estimate.
However, given that getting more and better quality data is not always feasible, considering other options is important.
My choice of covariates might have been inadequate, given the level of uncertainty in the final plots.
Including covariates which represented temporal changes, as well as spatial ones, could have produced more accurate and dynamic maps. 

This report also shows the importance of working alongside policy makes in making decisions. Changing the confidence level of the final data can have different outcomes. Ultimately, this decision is set by policy makers and should be done in conversation with other professionals, including health economists and anthropologists. 

# References 